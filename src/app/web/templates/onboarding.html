{% extends 'base.html' %}

{% block content %}
<section class="onboarding-hero glass-surface">
  <div class="hero-copy">
    <span class="badge">Alur 3 Langkah</span>
    <h1>Onboarding pengguna baru Sensasiwangi.id</h1>
    <p>
      Validasi alur registrasi, verifikasi email, dan pengisian profil dalam satu layar.
      Halaman ini membantu tim mengecek feedback langsung sebelum dirilis ke publik.
    </p>
  </div>
  <div class="hero-progress">
    <div class="progress-bar">
      <div class="progress-fill" data-progress-fill></div>
    </div>
    <ol class="progress-steps">
      {% for step in steps %}
      <li class="progress-step" data-progress-step data-step-key="{{ step.key }}">
        <span class="step-index">{{ loop.index }}</span>
        <div>
          <p class="step-title">{{ step.title }}</p>
          <p class="step-description">{{ step.description }}</p>
        </div>
      </li>
      {% endfor %}
    </ol>
  </div>
</section>

<section class="onboarding-layout">
  <div class="onboarding-main glass-surface">
    <header class="section-header">
      <div>
        <h2>Langkah-langkah</h2>
        <p>Lakukan 3 langkah sederhana untuk menyelesaikan onboarding.</p>
      </div>
      <div class="status-chip" data-status-label>Belum mulai</div>
    </header>

    <div id="onboarding-feedback" class="feedback" role="alert" aria-live="polite"></div>

    <div class="onboarding-forms">
      <form
        id="registration-form"
        data-step="register"
        class="onboarding-form"
        method="post"
        action="/api/onboarding/register"
      >
        <fieldset>
          <legend>1. Registrasi Pengguna</legend>
          <label>
            Nama Lengkap
            <input type="text" name="full_name" minlength="3" maxlength="120" placeholder="Mis. Ayu Laras" required />
          </label>
          <label>
            Email
            <input type="email" name="email" placeholder="nama@contoh.com" required />
          </label>
          <label>
            Password
            <input type="password" name="password" minlength="8" maxlength="128" placeholder="Minimal 8 karakter" required />
          </label>
          <label class="checkbox">
            <input type="checkbox" name="marketing_opt_in" value="true" />
            Kirimkan update komunitas via email
          </label>
        </fieldset>
        <button type="submit" class="btn gradient-button">Daftar &amp; Kirim Tautan</button>
      </form>

      <form
        id="verification-form"
        data-step="verify"
        class="onboarding-form"
        method="post"
        action="/api/onboarding/verify"
        aria-disabled="true"
      >
        <input type="hidden" name="onboarding_id" data-onboarding-id />
        <fieldset>
          <legend>2. Verifikasi Email</legend>
          <p class="form-help">
            Buka email yang kami kirimkan dan klik tautan verifikasi akun Anda.
            Jika diperlukan pengujian manual, token juga dapat dimasukkan di bawah ini (opsional). Token berlaku selama <span id="verification-countdown">--</span>.
          </p>
          <label>
            Token Verifikasi
            <input type="text" name="token" minlength="4" maxlength="64" placeholder="Masukkan token" required disabled />
          </label>
        </fieldset>
        <div class="form-actions">
          <button type="submit" class="btn btn-outline" disabled>Verifikasi Email</button>
          <button
            type="submit"
            class="btn btn-ghost"
            data-resend
            formaction="/api/onboarding/resend"
            disabled
          >
            Kirim Ulang Tautan
          </button>
        </div>
        <p class="debug-token" data-debug-token hidden></p>
      </form>

      <form
        id="profile-form"
        data-step="profile"
        class="onboarding-form"
        method="post"
        action="/api/onboarding/profile"
        aria-disabled="true"
      >
        <input type="hidden" name="onboarding_id" data-onboarding-id />
        <fieldset>
          <legend>3. Lengkapi Profil</legend>
          <label>
            Nama Brand / Tampilan
            <input type="text" name="display_name" minlength="2" maxlength="80" placeholder="Mis. Studio Senja" required disabled />
          </label>
          <label>
            Tujuan Bergabung
            <input type="text" name="business_goal" minlength="3" maxlength="160" placeholder="Mis. skala produksi parfum" required disabled />
          </label>
          <label>
            Pengalaman Meracik
            <select name="experience_level" required disabled>
              <option value="">Pilih pengalaman</option>
              <option value="Pemula">Pemula</option>
              <option value="Eksperimen Mandiri">Eksperimen Mandiri</option>
              <option value="Profesional">Profesional</option>
            </select>
          </label>
        </fieldset>
        <button type="submit" class="btn gradient-button" disabled>Selesaikan Onboarding</button>
      </form>
    </div>
  </div>

  
</section>

<script>
  const state = {
    onboardingId: null,
    progress: null,
    verificationToken: null,
    countdownTimer: null,
  };

  const feedbackEl = document.getElementById("onboarding-feedback");
  const progressFill = document.querySelector("[data-progress-fill]");
  const statusLabel = document.querySelector("[data-status-label]");
  const stepElements = document.querySelectorAll("[data-progress-step]");

  const registrationForm = document.getElementById("registration-form");
  const verificationForm = document.getElementById("verification-form");
  const profileForm = document.getElementById("profile-form");
  const onboardingIdInputs = document.querySelectorAll("input[data-onboarding-id]");
  const debugTokenEl = verificationForm.querySelector("[data-debug-token]");
  const countdownEl = document.getElementById("verification-countdown");

  function fallbackSubmit(form, submitter) {
    if (!form) return;
    const originalAction = form.getAttribute("action");
    const submitterAction = submitter?.formAction;
    if (submitterAction && submitterAction !== originalAction) {
      form.setAttribute("action", submitterAction);
    }
    form.submit();
    if (submitterAction && submitterAction !== originalAction) {
      if (originalAction) {
        form.setAttribute("action", originalAction);
      } else {
        form.removeAttribute("action");
      }
    }
  }

  function setFeedback(message, tone = "info") {
    feedbackEl.textContent = message;
    feedbackEl.dataset.tone = tone;
    if (message) {
      feedbackEl.classList.add("visible");
    } else {
      feedbackEl.classList.remove("visible");
    }
  }

  function updateProgress(progress) {
    state.progress = progress;
    const ratio = progress.total_steps > 1 ? (progress.step_index - 1) / (progress.total_steps - 1) : 0;
    const percent = Math.max(0, Math.min(ratio, 1)) * 100;
    progressFill.style.width = `${percent}%`;
    stepElements.forEach((element) => {
      const index = Number(element.querySelector(".step-index").textContent);
      element.classList.toggle("completed", index < progress.step_index);
      element.classList.toggle("active", index === progress.step_index);
    });
    statusLabel.textContent =
      progress.is_complete ? "Onboarding selesai" : `Langkah ${progress.step_index} dari ${progress.total_steps}`;
  }

  function enableForm(formEl, enabled) {
    formEl.dataset.enabled = String(enabled);
    formEl.setAttribute("aria-disabled", String(!enabled));
    const controls = formEl.querySelectorAll("input, select, button");
    controls.forEach((control) => {
      control.disabled = !enabled;
    });
  }

  function syncForms() {
    const status = state.progress ? state.progress.status : "registered";
    enableForm(verificationForm, Boolean(state.onboardingId) && status === "registered");
    enableForm(profileForm, status === "email_verified");
    const onboardingValue = state.onboardingId || "";
    onboardingIdInputs.forEach((input) => {
      input.value = onboardingValue;
      input.defaultValue = onboardingValue;
    });
  }

  function refreshCountdown(expiresAt) {
    if (state.countdownTimer) {
      clearInterval(state.countdownTimer);
    }

    if (!expiresAt) {
      countdownEl.textContent = "--";
      return;
    }

    const expiry = new Date(expiresAt);
    function tick() {
      const remaining = expiry - new Date();
      if (remaining <= 0) {
        clearInterval(state.countdownTimer);
        countdownEl.textContent = "kedaluwarsa";
        return;
      }
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      countdownEl.textContent = `${minutes}m ${seconds}s`;
    }

    tick();
    state.countdownTimer = setInterval(tick, 1000);
  }

  async function handleRegister(event) {
    if (typeof window.fetch !== "function") {
      return;
    }

    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    payload.marketing_opt_in = Boolean(payload.marketing_opt_in);

    setFeedback("Memproses registrasi...");
    try {
      const response = await fetch("/api/onboarding/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        setFeedback(error.detail || "Registrasi gagal", "danger");
        return;
      }

      const data = await response.json();
      state.onboardingId = data.onboarding_id;
      state.verificationToken = data.verification_token;
      verificationForm.reset();
      profileForm.reset();
      updateProgress(data.progress);
      syncForms();
      refreshCountdown(data.verification_expires_at);
      debugTokenEl.textContent = `Token verifikasi (QA): ${state.verificationToken}`;
      debugTokenEl.hidden = !state.verificationToken;
      setFeedback("Registrasi berhasil. Tautan verifikasi telah dikirim ke email Anda.", "success");
    } catch (error) {
      console.error(error);
      fallbackSubmit(form);
    }
  }

  async function handleVerification(event) {
    if (typeof window.fetch !== "function") {
      return;
    }

    event.preventDefault();
    const form = event.target;
    const submitter = event.submitter;

    if (!state.onboardingId) {
      fallbackSubmit(form, submitter);
      return;
    }

    if (submitter && submitter.hasAttribute("data-resend")) {
      await handleResend(event, submitter);
      return;
    }

    const formData = new FormData(form);
    const payload = { onboarding_id: state.onboardingId, token: formData.get("token") };

    setFeedback("Memeriksa token...");
    try {
      const response = await fetch("/api/onboarding/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        setFeedback(data.detail || "Token tidak valid", "danger");
        return;
      }

      updateProgress(data.progress);
      syncForms();
      refreshCountdown(data.progress.verification.expires_at);
      verificationForm.reset();
      setFeedback("Email berhasil diverifikasi.", "success");
    } catch (error) {
      console.error(error);
      fallbackSubmit(form, submitter);
    }
  }

  async function handleResend(event, submitter) {
    const form = event.target;
    if (!state.onboardingId) {
      fallbackSubmit(form, submitter);
      return;
    }

    setFeedback("Meminta token baru...");
    try {
      const response = await fetch("/api/onboarding/resend", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ onboarding_id: state.onboardingId }),
      });
      if (!response.ok) {
        setFeedback("Gagal memperbarui token", "danger");
        return;
      }
      const data = await response.json();
      state.verificationToken = data.verification_token;
      updateProgress(data.progress);
      syncForms();
      refreshCountdown(data.verification_expires_at);
      debugTokenEl.textContent = `Token verifikasi (QA): ${state.verificationToken}`;
      debugTokenEl.hidden = !state.verificationToken;
      verificationForm.reset();
      setFeedback("Tautan verifikasi baru dikirim. Cek email Anda.", "success");
    } catch (error) {
      console.error(error);
      fallbackSubmit(form, submitter);
    }
  }

  async function handleProfile(event) {
    if (typeof window.fetch !== "function") {
      return;
    }

    event.preventDefault();
    const form = event.target;
    if (!state.onboardingId) {
      fallbackSubmit(form);
      return;
    }

    const formData = new FormData(form);
    const payload = {
      onboarding_id: state.onboardingId,
      display_name: formData.get("display_name"),
      business_goal: formData.get("business_goal"),
      experience_level: formData.get("experience_level"),
    };

    setFeedback("Menyimpan profil...");
    try {
      const response = await fetch("/api/onboarding/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        setFeedback(data.detail || "Profil tidak valid", "danger");
        return;
      }

      updateProgress(data.progress);
      syncForms();
      setFeedback("Profil berhasil disimpan. Onboarding selesai!", "success");
      profileForm.reset();
    } catch (error) {
      console.error(error);
      fallbackSubmit(form);
    }
  }

  registrationForm.addEventListener("submit", handleRegister);
  verificationForm.addEventListener("submit", handleVerification);
  profileForm.addEventListener("submit", handleProfile);

  updateProgress({ step_index: 1, total_steps: 3, is_complete: false, status: "registered", verification: { active: false, expires_at: null } });
  syncForms();
</script>
{% endblock %}
