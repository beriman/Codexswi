{% extends 'base.html' %}

{% block content %}
<section class="marketplace-section" id="marketplace-catalog">
  <div class="section-header">
    <div>
      <span class="badge brand">Katalog Marketplace</span>
      <h1>Telusuri produk brand partner dan kreator komunitas</h1>
      <p>
        Gunakan tab kategori untuk beralih antara parfum siap pakai, bahan baku, peralatan, dan opsi
        pendukung lainnya.
      </p>
    </div>
    <form
      class="filter-form single-field section-search"
      role="search"
      aria-label="Cari produk marketplace"
    >
      <label class="field">
        <span>Pencarian</span>
        <input
          type="search"
          name="q"
          placeholder="Contoh: Pelangi Senja atau Ayu Prameswari"
          autocomplete="off"
          data-marketplace-search
        />
      </label>
      <p class="filter-hint">Ketik nama produk, brand, atau perfumer untuk menelusuri katalog.</p>
    </form>
  </div>

  <div class="catalog-tabs" role="tablist">
    {% for tab in marketplace_catalog %}
    <button
      type="button"
      class="catalog-tab {% if loop.first %}is-active{% endif %}"
      data-tab="{{ tab.slug }}"
      role="tab"
      id="tab-{{ tab.slug }}"
      aria-controls="panel-{{ tab.slug }}"
      aria-selected="{{ 'true' if loop.first else 'false' }}"
    >
      {{ tab.label }}
    </button>
    {% endfor %}
  </div>

  {% for tab in marketplace_catalog %}
  <div
    class="catalog-panel {% if not loop.first %}is-hidden{% endif %}"
    data-tab-panel="{{ tab.slug }}"
    role="tabpanel"
    id="panel-{{ tab.slug }}"
    aria-labelledby="tab-{{ tab.slug }}"
    {% if not loop.first %}hidden{% endif %}
  >
    <p class="panel-description">{{ tab.description }}</p>
    <p class="empty-state" data-empty-message hidden>Belum ada produk yang cocok dengan pencarian Anda.</p>
    <div class="product-grid marketplace-grid">
      {% for product in tab.products %}
      <article
        class="product-card glass-card"
        data-product-card
        data-name="{{ product.name }}"
        data-brand="{{ product.origin }}"
        data-perfumer="{{ product.perfumer or '' }}"
      >
        {% if product.sambatan %}
        <span class="product-badge product-badge-sambatan"
          ><span class="badge-icon" aria-hidden="true">ü§ù</span> Sambatan</span
        >
        {% endif %}
        <div class="product-media {{ product.media_class }}"></div>
        <div class="product-content">
          <div class="product-meta">
            <span class="product-category">{{ product.origin_type }}</span>
            <span class="product-owner">{{ product.origin }}</span>
          </div>
          <h3>{{ product.name }}</h3>
          {% if product.perfumer %}
          <p class="product-perfumer">Diracik oleh {{ product.perfumer }}</p>
          {% endif %}
          {% if product.description %}
          <p class="product-description">{{ product.description }}</p>
          {% elif product.notes %}
          <p class="product-description">{{ product.notes | join(', ') }}</p>
          {% endif %}
          <div class="product-footer">
            <span class="price">{{ product.price }}</span>
            {% if product.tags %}
            <div class="product-tags">
              {% for tag in product.tags %}
              <span class="tag">{{ tag }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% if product.sambatan %}
          <div class="progress-indicator">
            <span class="progress-label">{{ product.sambatan.slots_left }} slot tersisa</span>
            <div class="progress-track">
              <div class="progress-fill" style="--progress: {{ product.sambatan.progress_percent }}%"></div>
            </div>
            <span class="progress-deadline">{{ product.sambatan.deadline }}</span>
          </div>
          {% endif %}
          {% if product.availability %}
          <p class="product-availability">{{ product.availability }}</p>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<script>
  (function () {
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanels = document.querySelectorAll('[data-tab-panel]');
    const searchInput = document.querySelector('[data-marketplace-search]');

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.getAttribute('data-tab');

        tabButtons.forEach((tab) => {
          const isActive = tab === button;
          tab.classList.toggle('is-active', isActive);
          tab.setAttribute('aria-selected', String(isActive));
        });

        tabPanels.forEach((panel) => {
          const match = panel.getAttribute('data-tab-panel') === target;
          panel.classList.toggle('is-hidden', !match);
          panel.toggleAttribute('hidden', !match);
        });

        if (searchInput && searchInput.value.trim()) {
          applySearchFilter();
        }
      });
    });

    function normalise(value) {
      return value
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '');
    }

    function applySearchFilter() {
      const keyword = normalise(searchInput.value.trim());

      tabPanels.forEach((panel) => {
        const cards = panel.querySelectorAll('[data-product-card]');
        const emptyMessage = panel.querySelector('[data-empty-message]');
        let visibleCount = 0;

        cards.forEach((card) => {
          const name = normalise(card.dataset.name || '');
          const brand = normalise(card.dataset.brand || '');
          const perfumer = normalise(card.dataset.perfumer || '');
          const haystack = `${name} ${brand} ${perfumer}`.trim();
          const matches = !keyword || haystack.includes(keyword);

          card.classList.toggle('is-filtered-out', !matches);
          card.toggleAttribute('hidden', !matches);

          if (matches) {
            visibleCount += 1;
          }
        });

        const shouldShowEmpty = visibleCount === 0 && keyword;
        if (emptyMessage) {
          emptyMessage.toggleAttribute('hidden', !shouldShowEmpty);
        }
      });
    }

    if (searchInput) {
      ['input', 'change'].forEach((eventName) => {
        searchInput.addEventListener(eventName, applySearchFilter);
      });
    }
  })();
</script>
{% endblock %}
