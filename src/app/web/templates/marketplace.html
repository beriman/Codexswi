{% extends 'base.html' %}

{% block content %}
<section class="marketplace-section" id="marketplace-catalog">

  <div class="catalog-controls">
    <div class="catalog-tab-bar">
      <div class="catalog-tabs" role="tablist">
        {% for tab in marketplace_catalog %}
        <button
          type="button"
          class="catalog-tab {% if loop.first %}is-active{% endif %}"
          data-tab="{{ tab.slug }}"
          role="tab"
          id="tab-{{ tab.slug }}"
          aria-controls="panel-{{ tab.slug }}"
          aria-selected="{{ 'true' if loop.first else 'false' }}"
        >
          {{ tab.label }}
        </button>
        {% endfor %}
      </div>
      <form
        class="catalog-search"
        role="search"
        aria-label="Cari produk marketplace"
        data-marketplace-search-form
        method="get"
        action="{{ url_for('read_marketplace') }}"
      >
        <label class="sr-only" for="marketplace-search-input">Cari produk marketplace</label>
        <div class="catalog-search-input">
          <span class="catalog-search-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
              <path
                d="M11 4a7 7 0 1 1 0 14 7 7 0 0 1 0-14Zm8.53 13.47-2.87-2.87"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </span>
          <input
            id="marketplace-search-input"
            type="search"
            name="q"
            placeholder="Cari di katalog"
            autocomplete="off"
            data-marketplace-search
            value="{{ active_query | default('', true) }}"
          />
          <button type="submit" class="catalog-search-button">
            <span class="sr-only">Cari</span>
            <svg viewBox="0 0 20 20" focusable="false" aria-hidden="true">
              <path
                d="M9 3a6 6 0 1 1 0 12 6 6 0 0 1 0-12Zm7 12-2.6-2.6"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>

  {% for tab in marketplace_catalog %}
  <div
    class="catalog-panel {% if not loop.first %}is-hidden{% endif %}"
    data-tab-panel="{{ tab.slug }}"
    role="tabpanel"
    id="panel-{{ tab.slug }}"
    aria-labelledby="tab-{{ tab.slug }}"
    {% if not loop.first %}hidden{% endif %}
  >
    <p class="panel-description">{{ tab.description }}</p>
    <p
      class="empty-state"
      data-empty-message
      {% if not active_query or tab.products %}hidden{% endif %}
    >Belum ada produk yang cocok dengan pencarian Anda.</p>
    <div class="product-grid marketplace-grid">
      {% for product in tab.products %}
      {% set card_contents %}
      {% if product.sambatan %}
      <span class="product-badge product-badge-sambatan">
        {{ product.sambatan.slots_taken }}/{{ product.sambatan.total_slots }}
      </span>
      {% endif %}
      <div class="product-content">
        <div class="product-media {{ product.media_class }}"></div>
        <div class="product-info">
          <h3 class="product-name">{{ product.name }}</h3>
          {% set brand_markup -%}
          <span class="product-brand-label">
            {{ product.origin }}
            {% if product.brand_verified %}
            <span class="brand-verified-badge" role="img" aria-label="Brand terverifikasi">
              <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                <path
                  d="m6.5 10.5 5-5M4 8l2.5 2.5"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            {% endif %}
          </span>
          {%- endset %}
          {% if product.brand_slug %}
          <small
            class="product-brand"
            role="link"
            tabindex="0"
            data-brand-link
            data-brand-url="/brands/{{ product.brand_slug }}"
          >
            {{ brand_markup | trim | safe }}
          </small>
          {% else %}
          <small class="product-brand">{{ brand_markup | trim | safe }}</small>
          {% endif %}
          {% if product.price %}
          <p class="product-price">{{ product.price }}</p>
          {% endif %}
        </div>
      </div>
      {% endset %}
      {% if product.slug %}
      <a
        class="product-card glass-card"
        data-product-card
        data-name="{{ product.name }}"
        data-brand="{{ product.origin }}"
        data-perfumer="{{ product.perfumer or '' }}"
        href="/marketplace/products/{{ product.slug }}"
      >
        {{ card_contents | trim | safe }}
      </a>
      {% else %}
      <article
        class="product-card glass-card"
        data-product-card
        data-name="{{ product.name }}"
        data-brand="{{ product.origin }}"
        data-perfumer="{{ product.perfumer or '' }}"
      >
        {{ card_contents | trim | safe }}
      </article>
      {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<script>
  (function () {
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanels = document.querySelectorAll('[data-tab-panel]');
    const searchInput = document.querySelector('[data-marketplace-search]');
    const searchForm = document.querySelector('[data-marketplace-search-form]');

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const target = button.getAttribute('data-tab');

        tabButtons.forEach((tab) => {
          const isActive = tab === button;
          tab.classList.toggle('is-active', isActive);
          tab.setAttribute('aria-selected', String(isActive));
        });

        tabPanels.forEach((panel) => {
          const match = panel.getAttribute('data-tab-panel') === target;
          panel.classList.toggle('is-hidden', !match);
          panel.toggleAttribute('hidden', !match);
        });

        if (searchInput && searchInput.value.trim()) {
          applySearchFilter();
        }
      });
    });

    function normalise(value) {
      return value
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '');
    }

    function applySearchFilter() {
      const keyword = normalise(searchInput.value.trim());

      tabPanels.forEach((panel) => {
        const cards = panel.querySelectorAll('[data-product-card]');
        const emptyMessage = panel.querySelector('[data-empty-message]');
        let visibleCount = 0;

        cards.forEach((card) => {
          const name = normalise(card.dataset.name || '');
          const brand = normalise(card.dataset.brand || '');
          const perfumer = normalise(card.dataset.perfumer || '');
          const haystack = `${name} ${brand} ${perfumer}`.trim();
          const matches = !keyword || haystack.includes(keyword);

          card.classList.toggle('is-filtered-out', !matches);
          card.toggleAttribute('hidden', !matches);

          if (matches) {
            visibleCount += 1;
          }
        });

        const shouldShowEmpty = visibleCount === 0 && keyword;
        if (emptyMessage) {
          emptyMessage.toggleAttribute('hidden', !shouldShowEmpty);
        }
      });
    }

    if (searchInput) {
      ['input', 'change'].forEach((eventName) => {
        searchInput.addEventListener(eventName, applySearchFilter);
      });
    }

    function updateQueryString(nextQuery) {
      const url = new URL(window.location.href);

      if (nextQuery) {
        url.searchParams.set('q', nextQuery);
      } else {
        url.searchParams.delete('q');
      }

      const newUrl = `${url.pathname}${url.search}${url.hash}`;

      if (window.history && typeof window.history.replaceState === 'function') {
        window.history.replaceState({}, '', newUrl);
      } else {
        window.location.assign(newUrl);
      }
    }

    if (searchForm) {
      searchForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(searchForm);
        const submittedQuery = String(formData.get('q') || '').trim();

        applySearchFilter();
        updateQueryString(submittedQuery);
      });
    }

    if (searchInput && searchInput.value.trim()) {
      applySearchFilter();
    }

    const fallbackCards = document.querySelectorAll('[data-product-card]:not([href])');

    fallbackCards.forEach((card) => {
      const destination = card.dataset.productUrl;

      if (!destination) {
        return;
      }

      card.addEventListener('click', () => {
        window.location.href = destination;
      });

      card.addEventListener('keydown', (event) => {
        if (event.target !== card) {
          return;
        }

        if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
          event.preventDefault();
          window.location.href = destination;
        }
      });
    });

    const brandLinks = document.querySelectorAll('[data-brand-link]');

    brandLinks.forEach((element) => {
      const destination = element.dataset.brandUrl;

      if (!destination) {
        return;
      }

      const navigateToBrand = () => {
        window.location.href = destination;
      };

      element.addEventListener('click', (event) => {
        event.stopPropagation();
        navigateToBrand();
      });

      element.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
          event.preventDefault();
          event.stopPropagation();
          navigateToBrand();
        }
      });
    });
  })();
</script>
{% endblock %}
