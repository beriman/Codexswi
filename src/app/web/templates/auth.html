{% extends 'base.html' %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', path='css/auth.min.css') if use_minified else url_for('static', path='css/auth.css') }}?v={{ static_asset_query }}" />
{% endblock %}

{% block content %}
<section class="auth-page">
  <div class="auth-login-section" id="login">
    <div class="login-backdrop glass-surface">
      <div class="auth-feedback" data-auth-feedback role="status" aria-live="polite"></div>
      <form
        id="auth-login-form"
        class="auth-form login-form"
        aria-labelledby="login-title"
        method="post"
        action="{{ url_for('login_user') }}"
      >
        <header class="login-header">
          <h2 id="login-title">Masuk</h2>
          <p>Gunakan email dan password yang sama dengan akun Sensasiwangi.id Anda. Pastikan Anda sudah mengklik tautan verifikasi yang dikirim ke email.</p>
        </header>
        <label>
          Email
          <input type="email" name="email" placeholder="anda@contoh.com" autocomplete="email" required />
          <p class="input-hint">Masukkan email terdaftar Anda. Login menggunakan username belum didukung.</p>
        </label>
        <label>
          Password
          <input type="password" name="password" minlength="8" maxlength="128" placeholder="Password" required />
        </label>
        <div class="login-aux">
          <a href="#" class="forgot-link">Lupa password?</a>
        </div>
        <button type="submit" class="btn btn-outline">Masuk</button>
        <div class="login-divider" role="separator" aria-hidden="true">atau</div>
        <a class="btn gradient-button register-button" href="{{ url_for('read_onboarding') }}">Daftar Akun Baru</a>
        <p class="form-note">Sesi login disimpan pada cookie terenkripsi selama 30 hari. Jika belum menerima tautan verifikasi, cek folder spam atau ajukan pengiriman ulang melalui halaman onboarding.</p>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block body_scripts %}
<script>
  (() => {
    const feedbackEl = document.querySelector('[data-auth-feedback]');
    const loginForm = document.getElementById('auth-login-form');

    const setFeedback = (message, tone = 'info') => {
      if (!feedbackEl) return;
      feedbackEl.textContent = message || '';
      feedbackEl.dataset.tone = tone;
      feedbackEl.classList.toggle('visible', Boolean(message));
    };

    const handleResponseError = async (response) => {
      const payload = await response.json().catch(() => ({}));
      setFeedback(payload.detail || 'Permintaan gagal diproses', 'danger');
    };

    if (loginForm) {
      loginForm.addEventListener('submit', async (event) => {
        const supportsFetch = typeof window.fetch === 'function';
        if (!supportsFetch) {
          return;
        }

        event.preventDefault();
        const formData = new FormData(loginForm);
        const payload = Object.fromEntries(formData.entries());

        setFeedback('Memproses login...');
        let response;
        try {
          response = await window.fetch(loginForm.action || '/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
        } catch (error) {
          setFeedback('Koneksi bermasalah. Mengalihkan ke metode bawaan...', 'warning');
          window.setTimeout(() => loginForm.submit(), 0);
          return;
        }

        if (!response.ok) {
          await handleResponseError(response);
          return;
        }

        const data = await response.json();
        setFeedback(`Login berhasil. Selamat datang, ${data.full_name}!`, 'success');
        window.setTimeout(() => {
          window.location.href = '{{ url_for('read_auth') }}';
        }, 600);
      });
    }
  })();
</script>
{% endblock %}
