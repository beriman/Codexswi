{% extends 'base.html' %}

{% block content %}
<section class="product-detail-page">
  <div class="product-detail-container">
    <nav class="product-breadcrumb" aria-label="Breadcrumb">
      <ol>
        {% for crumb in breadcrumbs %}
        <li>
          {% if crumb.url %}
          <a href="{{ crumb.url }}">{{ crumb.label }}</a>
          {% else %}
          <span aria-current="page">{{ crumb.label }}</span>
          {% endif %}
        </li>
        {% endfor %}
      </ol>
    </nav>

    <div class="product-detail-hero glass-panel">
      <div class="product-hero-copy">
        <span class="hero-kicker">{{ product.hero_kicker }}</span>
        <h1>{{ product.name }}</h1>
        <p class="product-tagline">{{ product.tagline }} • {{ product.brand }}</p>
        <p class="product-summary">{{ product.summary }}</p>
        <p class="product-description">{{ product.description }}</p>
        <div class="product-pricing">
          <span class="price-primary">{{ product.price_primary }}</span>
          <span class="price-secondary">{{ product.price_secondary }}</span>
        </div>
        <div class="product-volume-options" role="list">
          {% for option in product.volume_options %}
          <div class="volume-option" role="listitem">
            <span class="volume-size">{{ option.size }}</span>
            <span class="volume-price">{{ option.price }}</span>
          </div>
          {% endfor %}
        </div>
        {% if product.purchase.mode == 'sambatan' %}
        <section class="purchase-mode purchase-mode--sambatan" aria-label="Detail pembelian sambatan">
          <header class="purchase-mode__header">
            <span class="badge sambatan">Sambatan Komunitas</span>
            <p>{{ product.purchase.description }}</p>
            <strong class="purchase-mode__price">{{ product.purchase.slot_price_label }}</strong>
          </header>
          <div class="sambatan-progress" role="status" aria-live="polite">
            <div class="sambatan-progress__bar">
              <span
                class="sambatan-progress__fill"
                style="--progress: {{ product.purchase.progress_percent }}%"
                aria-hidden="true"
              ></span>
            </div>
            <div class="sambatan-progress__meta">
              <span>{{ product.purchase.slots_taken }} slot terisi</span>
              <span>{{ product.purchase.slots_remaining }} slot tersisa dari {{ product.purchase.slots_total }}</span>
            </div>
          </div>
          <div class="slot-selector" role="group" aria-label="Pilih jumlah slot sambatan">
            <button type="button" class="slot-stepper" aria-label="Kurangi slot" data-direction="-1">−</button>
            <input
              type="number"
              inputmode="numeric"
              min="1"
              max="{{ product.purchase.max_slots_per_user }}"
              value="1"
              class="slot-input"
              aria-label="Jumlah slot sambatan"
            />
            <button type="button" class="slot-stepper" aria-label="Tambah slot" data-direction="1">+</button>
          </div>
          <p class="slot-hint">Ambil hingga {{ product.purchase.max_slots_per_user }} slot untuk mengamankan stokmu.</p>
          <ul class="purchase-benefits">
            {% for benefit in product.purchase.benefits %}
            <li>{{ benefit }}</li>
            {% endfor %}
          </ul>
          <button type="button" class="button button-primary product-cta">{{ product.purchase.cta_label }}</button>
          <p class="purchase-footnote">{{ product.purchase.deadline_text }}</p>
        </section>
        {% else %}
        <section class="purchase-mode purchase-mode--regular" aria-label="Detail pembelian reguler">
          <h3>Pembelian Reguler</h3>
          <ul class="purchase-benefits">
            {% for benefit in product.purchase.benefits %}
            <li>{{ benefit }}</li>
            {% endfor %}
          </ul>
          <button type="button" class="button button-primary product-cta">{{ product.purchase.cta_label }}</button>
          <p class="purchase-footnote">{{ product.purchase.supporting_text }}</p>
        </section>
        {% endif %}
        <p class="origin-info">Diracik di {{ product.origin_city }}</p>
      </div>
      <div class="product-hero-visual {{ product.image_class | default('product-visual-default') }}" aria-hidden="true">
        <div class="product-visual-glow"></div>
      </div>
    </div>

    <div class="product-detail-grid">
      <section class="glass-panel scent-profile">
        <header>
          <h2>Profil Aroma</h2>
          <p>Piramida aroma dirancang untuk memberikan transisi halus dari pembuka hingga basis.</p>
        </header>
        <div class="scent-columns">
          {% for layer in product.scent_pyramid %}
            <div class="scent-column">
              <h3>{{ layer.title }}</h3>
              <ul>
                {% for note in layer.notes %}
                <li>{{ note }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </div>
      </section>

      <section class="glass-panel experience-section">
        <header>
          <h2>Kenapa Kolektor Memilihnya</h2>
        </header>
        <ul class="experience-list">
          {% for item in product.experience_points %}
          <li>{{ item }}</li>
          {% endfor %}
        </ul>
        <div class="production-meta">
          <div>
            <span class="meta-label">Durasi macerasi</span>
            <strong>{{ product.production_notes.macration }}</strong>
          </div>
          <div>
            <span class="meta-label">Jumlah tiap batch</span>
            <strong>{{ product.production_notes.bottle_batch }}</strong>
          </div>
          <div>
            <span class="meta-label">Estimasi pengiriman</span>
            <strong>{{ product.production_notes.dispatch }}</strong>
          </div>
        </div>
      </section>

      <aside class="glass-panel featured-categories">
        <h2>Featured Categories</h2>
        <ul class="category-chips">
          {% for category in product.featured_categories %}
          <li><span class="category-chip">{{ category.label }}</span></li>
          {% endfor %}
        </ul>
        <div class="featured-summary">
          <p>
            Eksplor pilihan kategori untuk menemukan parfum lain dalam kisaran aroma dan karakter yang serupa.
          </p>
        </div>
      </aside>
    </div>

    <section class="glass-panel recommendations">
      <header>
        <h2>Rekomendasi Lainnya</h2>
        <p>Produk dengan DNA aroma yang melengkapi koleksi Anda.</p>
      </header>
      <div class="recommendation-grid">
        {% for item in product.recommendations %}
        <article class="recommendation-card">
          <div class="recommendation-visual {{ item.media_class }}" aria-hidden="true"></div>
          <div class="recommendation-body">
            <h3>{{ item.name }}</h3>
            <p>{{ item.category }}</p>
            <span class="recommendation-price">{{ item.price }}</span>
            <a class="button button-ghost" href="/marketplace/products/{{ item.slug }}">Lihat detail</a>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
  </div>
</section>
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    (function () {
      const slotSelector = document.querySelector('.slot-selector');
      if (!slotSelector) {
        return;
      }

      const input = slotSelector.querySelector('.slot-input');
      const steppers = slotSelector.querySelectorAll('.slot-stepper');
      const hint = slotSelector.nextElementSibling && slotSelector.nextElementSibling.classList.contains('slot-hint')
        ? slotSelector.nextElementSibling
        : null;

      if (!input || steppers.length === 0) {
        return;
      }

      const min = input.hasAttribute('min') ? Number.parseInt(input.getAttribute('min'), 10) : 0;
      const max = input.hasAttribute('max') ? Number.parseInt(input.getAttribute('max'), 10) : Number.POSITIVE_INFINITY;

      if (hint) {
        hint.dataset.baseHint = hint.textContent.trim();
        if (!hint.hasAttribute('aria-live')) {
          hint.setAttribute('aria-live', 'polite');
        }
      }

      const clampValue = (value) => {
        const numericValue = Number.isNaN(value) ? min : value;
        return Math.min(max, Math.max(min, numericValue));
      };

      const updateUI = (rawValue) => {
        const currentValue = clampValue(rawValue);
        if (input.value !== String(currentValue)) {
          input.value = String(currentValue);
        }

        steppers.forEach((button) => {
          const direction = Number.parseInt(button.dataset.direction || '0', 10);
          if (direction < 0) {
            button.disabled = currentValue <= min;
          } else if (direction > 0) {
            button.disabled = currentValue >= max;
          }
        });

        if (hint) {
          const baseText = hint.dataset.baseHint || '';
          const selectionText = `Saat ini memilih ${currentValue} slot.`;
          hint.textContent = baseText ? `${baseText} ${selectionText}` : selectionText;
        }

        return currentValue;
      };

      steppers.forEach((button) => {
        button.addEventListener('click', () => {
          const direction = Number.parseInt(button.dataset.direction || '0', 10);
          if (!direction) {
            return;
          }

          const current = Number.parseInt(input.value, 10);
          const nextValue = clampValue((Number.isNaN(current) ? min : current) + direction);
          const updatedValue = updateUI(nextValue);
          if (updatedValue !== current) {
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      });

      input.addEventListener('input', () => {
        const numericValue = Number.parseInt(input.value, 10);
        updateUI(Number.isNaN(numericValue) ? min : numericValue);
      });

      input.addEventListener('blur', () => {
        const numericValue = Number.parseInt(input.value, 10);
        updateUI(Number.isNaN(numericValue) ? min : numericValue);
      });

      updateUI(Number.parseInt(input.value, 10));
    })();
  </script>
{% endblock %}
