<form
  id="nusantarum-filter-form"
  class="nusantarum-filter-panel"
  method="get"
  action="{{ url_for('read_nusantarum') }}"
  hx-get="/nusantarum/tab/{{ active_tab }}"
  hx-target="#nusantarum-tab-content"
  hx-trigger="change delay:250ms"
  hx-include="#nusantarum-filter-form"
  hx-push-url="/nusantarum?tab={{ active_tab }}{% if active_tab == 'parfum' and sort and sort != 'synced_at' %}&sort={{ sort }}{% if direction %}&direction={{ direction }}{% endif %}{% endif %}"
  onsubmit="if (this.dataset.htmxProcessing === 'true') { event.preventDefault(); }"
>
  <input type="hidden" name="tab" value="{{ active_tab }}" />
  <input
    type="hidden"
    name="sort"
    value="{{ sort if active_tab == 'parfum' and sort and sort != 'synced_at' else '' }}"
  />
  <input
    type="hidden"
    name="direction"
    value="{{ direction if active_tab == 'parfum' and sort and sort != 'synced_at' else '' }}"
  />
  <h2>Filter Nusantarum</h2>
  <p class="text-muted">Sesuaikan direktori berdasarkan aroma, lokasi brand, dan status verifikasi.</p>

  <section>
    <h3>Aroma Families</h3>
    <div class="filter-chip-group">
      {% set aroma_options = [
        "Floral",
        "Citrus",
        "Woody",
        "Oriental",
        "Fruity",
        "Gourmand",
        "Fresh"
      ] %}
      {% for option in aroma_options %}
      <label class="filter-chip">
        <input type="checkbox" name="families" value="{{ option }}" {% if option in filters.families %}checked{% endif %} />
        <span>{{ option }}</span>
      </label>
      {% endfor %}
    </div>
  </section>

  <section>
    <h3>Kota Brand</h3>
    <input
      type="search"
      name="city"
      value="{{ filters.city or '' }}"
      placeholder="Cari kota atau provinsi"
    />
  </section>

  <section>
    <h3>Rentang Harga</h3>
    <div class="filter-chip-group">
      <label>
        <span class="sr-only">Harga minimum</span>
        <input type="number" name="price_min" min="0" step="50000" value="{{ filters.price_min or '' }}" placeholder="Mulai dari" />
      </label>
      <label>
        <span class="sr-only">Harga maksimum</span>
        <input type="number" name="price_max" min="0" step="50000" value="{{ filters.price_max or '' }}" placeholder="Sampai" />
      </label>
    </div>
  </section>

  <section>
    <h3>Status Verifikasi</h3>
    <label class="toggle">
      <input type="checkbox" name="verified" value="true" {% if filters.verified %}checked{% endif %} />
      <span>Hanya tampilkan brand terverifikasi</span>
    </label>
  </section>

  {% if sync_status %}
  <section>
    <h3>Status Sinkronisasi</h3>
    <div class="sync-status-list">
      {% for status in sync_status %}
      <div class="sync-status-item">
        <span>{{ status.source|title }}</span>
        <span>{{ status.run_at.strftime('%d %b %Y %H:%M') }}</span>
        <span>{{ status.status }}</span>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}
  <div class="filter-actions">
    <button type="submit" class="filter-submit">Terapkan filter</button>
  </div>
</form>
<script>
  (function () {
    const form = document.getElementById('nusantarum-filter-form');
    if (!form) {
      return;
    }

    form.addEventListener('htmx:configRequest', function () {
      form.dataset.htmxProcessing = 'true';
    });

    form.addEventListener('htmx:afterRequest', function () {
      delete form.dataset.htmxProcessing;
    });

  })();
</script>
