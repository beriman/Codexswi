{% set current_sort = sort if sort else 'synced_at' %}
{% if current_sort != 'synced_at' and not direction %}
  {% if current_sort in ['name', 'brand'] %}
    {% set current_direction = 'asc' %}
  {% else %}
    {% set current_direction = 'desc' %}
  {% endif %}
{% else %}
  {% set current_direction = direction if direction else 'desc' %}
{% endif %}
{% if error_message %}
<div class="nusantarum-empty">
  <p>{{ error_message }}</p>
</div>
{% elif page %}
  {% if page.items %}
  <div class="nusantarum-table-wrapper">
    <table class="nusantarum-table">
      <caption class="sr-only">Daftar parfum Nusantarum</caption>
      <thead>
        <tr>
          {% set name_is_active = current_sort == 'name' %}
          {% set name_next_direction = 'desc' if name_is_active and current_direction == 'asc' else 'asc' %}
          <th
            scope="col"
            {% if name_is_active %}
            aria-sort="{{ 'ascending' if current_direction == 'asc' else 'descending' }}"
            {% endif %}
          >
            <button
              type="button"
              class="nusantarum-table__sort"
              hx-get="/nusantarum/tab/{{ active_tab }}"
              hx-target="#nusantarum-tab-content"
              hx-include="#nusantarum-filter-form"
              hx-vals='{"page": 1, "page_size": {{ page.page_size }}, "tab": "{{ active_tab }}", "sort": "name", "direction": "{{ name_next_direction }}"}'
              hx-push-url="/nusantarum?tab={{ active_tab }}&page=1&page_size={{ page.page_size }}&sort=name&direction={{ name_next_direction }}"
            >
              <span>Nama Parfum</span>
              <span aria-hidden="true" class="nusantarum-table__sort-indicator">
                {% if name_is_active %}
                  {% if current_direction == 'asc' %}↑{% else %}↓{% endif %}
                {% else %}
                  ⇅
                {% endif %}
              </span>
              <span class="sr-only">
                Urutkan {{ 'menurun' if name_next_direction == 'desc' else 'menaik' }} berdasarkan nama parfum
              </span>
            </button>
          </th>
          {% set brand_is_active = current_sort == 'brand' %}
          {% set brand_next_direction = 'desc' if brand_is_active and current_direction == 'asc' else 'asc' %}
          <th
            scope="col"
            {% if brand_is_active %}
            aria-sort="{{ 'ascending' if current_direction == 'asc' else 'descending' }}"
            {% endif %}
          >
            <button
              type="button"
              class="nusantarum-table__sort"
              hx-get="/nusantarum/tab/{{ active_tab }}"
              hx-target="#nusantarum-tab-content"
              hx-include="#nusantarum-filter-form"
              hx-vals='{"page": 1, "page_size": {{ page.page_size }}, "tab": "{{ active_tab }}", "sort": "brand", "direction": "{{ brand_next_direction }}"}'
              hx-push-url="/nusantarum?tab={{ active_tab }}&page=1&page_size={{ page.page_size }}&sort=brand&direction={{ brand_next_direction }}"
            >
              <span>Brand</span>
              <span aria-hidden="true" class="nusantarum-table__sort-indicator">
                {% if brand_is_active %}
                  {% if current_direction == 'asc' %}↑{% else %}↓{% endif %}
                {% else %}
                  ⇅
                {% endif %}
              </span>
              <span class="sr-only">
                Urutkan {{ 'menurun' if brand_next_direction == 'desc' else 'menaik' }} berdasarkan nama brand
              </span>
            </button>
          </th>
          <th scope="col">Profil Aroma</th>
          {% set release_is_active = current_sort == 'updated_at' %}
          {% set release_next_direction = 'asc' if release_is_active and current_direction == 'desc' else 'desc' %}
          <th
            scope="col"
            {% if release_is_active %}
            aria-sort="{{ 'ascending' if current_direction == 'asc' else 'descending' }}"
            {% endif %}
          >
            <button
              type="button"
              class="nusantarum-table__sort"
              hx-get="/nusantarum/tab/{{ active_tab }}"
              hx-target="#nusantarum-tab-content"
              hx-include="#nusantarum-filter-form"
              hx-vals='{"page": 1, "page_size": {{ page.page_size }}, "tab": "{{ active_tab }}", "sort": "updated_at", "direction": "{{ release_next_direction }}"}'
              hx-push-url="/nusantarum?tab={{ active_tab }}&page=1&page_size={{ page.page_size }}&sort=updated_at&direction={{ release_next_direction }}"
            >
              <span>Tahun Rilis</span>
              <span aria-hidden="true" class="nusantarum-table__sort-indicator">
                {% if release_is_active %}
                  {% if current_direction == 'asc' %}↑{% else %}↓{% endif %}
                {% else %}
                  ⇅
                {% endif %}
              </span>
              <span class="sr-only">
                Urutkan {{ 'menaik' if release_next_direction == 'asc' else 'menurun' }} berdasarkan tahun rilis
              </span>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for perfume in page.items %}
        <tr>
          <th scope="row" data-label="Nama Parfum">
            <a class="nusantarum-link" href="/products/{{ perfume.id }}">{{ perfume.name }}</a>
            {% if perfume.hero_note %}
            <p class="nusantarum-table__description">{{ perfume.hero_note }}</p>
            {% elif perfume.description %}
            <p class="nusantarum-table__description">
              {{ perfume.description[:160] }}{% if perfume.description|length > 160 %}…{% endif %}
            </p>
            {% endif %}
          </th>
          <td data-label="Brand">
            {% if perfume.brand_profile_url %}
            <a class="nusantarum-link" href="{{ perfume.brand_profile_url }}">{{ perfume.brand_name }}</a>
            {% else %}
            {{ perfume.brand_name }}
            {% endif %}
            {% if perfume.perfumer_name %}
            <p class="nusantarum-table__meta">
              oleh
              {% if perfume.perfumer_profile_url %}
              <a class="nusantarum-link" href="{{ perfume.perfumer_profile_url }}">{{ perfume.perfumer_name }}</a>
              {% else %}
              {{ perfume.perfumer_name }}
              {% endif %}
            </p>
            {% endif %}
          </td>
          <td data-label="Profil Aroma">
            <div class="nusantarum-aroma-group">
              {% if perfume.aroma_families %}
              {% for family in perfume.aroma_families %}
              <span class="nusantarum-badge">{{ family }}</span>
              {% endfor %}
              {% else %}
              <span class="nusantarum-table__meta">Belum diklasifikasikan</span>
              {% endif %}
            </div>
          </td>
          <td data-label="Tahun Rilis">
            {% if perfume.updated_at %}
            {{ perfume.updated_at.year }}
            {% else %}
            <span class="nusantarum-table__meta">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="nusantarum-empty">
    <h3>Tidak ada parfum yang cocok</h3>
    <p>Coba bersihkan filter aroma atau ubah kata kunci pencarian Anda.</p>
    <ul class="nusantarum-empty__suggestions">
      <li>Telusuri kategori aroma lain seperti <strong>Woody</strong> atau <strong>Fresh</strong>.</li>
      <li>Hapus filter kota untuk melihat seluruh Nusantara.</li>
      <li>Gunakan pencarian umum seperti "kopi", "melati", atau "rempah".</li>
    </ul>
  </div>
  {% endif %}
  <div class="nusantarum-pagination">
    {% set prev_page = page.page - 1 if page.page > 1 else 1 %}
    {% set next_page = page.page + 1 if page.page < page.pages else page.pages %}
    <button
      type="button"
      class="nusantarum-pagination__button"
      hx-get="/nusantarum/tab/{{ active_tab }}"
      hx-target="#nusantarum-tab-content"
      hx-include="#nusantarum-filter-form"
      hx-vals='{"page": {{ prev_page }}, "page_size": {{ page.page_size }}, "tab": "{{ active_tab }}"{% if current_sort != 'synced_at' %}, "sort": "{{ current_sort }}", "direction": "{{ current_direction }}"{% endif %}}'
      hx-push-url="/nusantarum?tab={{ active_tab }}&page={{ prev_page }}&page_size={{ page.page_size }}{% if current_sort != 'synced_at' %}&sort={{ current_sort }}&direction={{ current_direction }}{% endif %}"
      {% if page.page <= 1 %}disabled{% endif %}
    >Sebelumnya</button>
    <span class="nusantarum-pagination__status">Halaman {{ page.page }} dari {{ page.pages }}</span>
    <button
      type="button"
      class="nusantarum-pagination__button"
      hx-get="/nusantarum/tab/{{ active_tab }}"
      hx-target="#nusantarum-tab-content"
      hx-include="#nusantarum-filter-form"
      hx-vals='{"page": {{ next_page }}, "page_size": {{ page.page_size }}, "tab": "{{ active_tab }}"{% if current_sort != 'synced_at' %}, "sort": "{{ current_sort }}", "direction": "{{ current_direction }}"{% endif %}}'
      hx-push-url="/nusantarum?tab={{ active_tab }}&page={{ next_page }}&page_size={{ page.page_size }}{% if current_sort != 'synced_at' %}&sort={{ current_sort }}&direction={{ current_direction }}{% endif %}"
      {% if page.page >= page.pages %}disabled{% endif %}
    >Berikutnya</button>
  </div>
{% else %}
<div class="nusantarum-empty">
  <p>Direktori belum dapat dimuat.</p>
</div>
{% endif %}
