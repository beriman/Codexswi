{% extends 'base.html' %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', path='css/moderation-dashboard.css') }}?{{ static_asset_query }}" />
{% endblock %}

{% block content %}
{% set persona = snapshot.persona %}
<section class="mod-hero glass-surface">
  <div class="mod-hero__main">
    <span class="role-badge">{{ persona.role }}</span>
    <h1>Halo, {{ persona.name }} ðŸ‘‹</h1>
    <p class="mission">{{ persona.mission }}</p>
    <dl class="hero-meta" aria-label="Detail shift dan fokus hari ini">
      <div>
        <dt>Hari &amp; Tanggal</dt>
        <dd>{{ persona.date }}</dd>
      </div>
      <div>
        <dt>Shift Aktif</dt>
        <dd>{{ persona.shift }}</dd>
      </div>
      <div>
        <dt>Fokus</dt>
        <dd>{{ persona.focus }}</dd>
      </div>
    </dl>
    <div class="hero-actions">
      <a href="{{ url_for('read_onboarding') }}" class="btn gradient-button" data-action="add-moderator">Tambah Moderator</a>
      <a href="#mod-policies" class="btn btn-outline" data-action="view-sop">Lihat SOP</a>
      <button type="button" class="btn btn-ghost" data-action="share-report" data-share-url="{{ request.url }}">Bagikan Laporan</button>
    </div>
    <p class="acknowledgement">ðŸ”” {{ persona.acknowledgement }}</p>
  </div>
  <div class="mod-hero__kpis">
    <ul class="kpi-grid" role="list">
      {% for kpi in snapshot.kpis %}
      <li class="kpi-card glass-card tone-{{ kpi.tone }}" role="listitem">
        <p class="kpi-label">{{ kpi.label }}</p>
        <p class="kpi-value">{{ kpi.value }}</p>
        <p class="kpi-delta">{{ kpi.delta }}</p>
      </li>
      {% endfor %}
    </ul>
  </div>
</section>

<nav class="mod-section-tabs glass-surface" aria-label="Navigasi section dashboard" data-tab-group>
  <div class="tab-bar">
    <div class="tab-scroller">
      <ul class="tab-list">
        <li class="tab-list__item">
          <a class="tab-link is-active" href="#mod-overview" data-action="jump-section" data-target="#mod-overview">
            <span class="tab-label">Overview</span>
            <span class="tab-subtitle">Ringkasan</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-team" data-action="jump-section" data-target="#mod-team">
            <span class="tab-label">Tim</span>
            <span class="tab-subtitle">Manajemen</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-queues" data-action="jump-section" data-target="#mod-queues">
            <span class="tab-label">Antrian</span>
            <span class="tab-subtitle">Moderasi</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-curation" data-action="jump-section" data-target="#mod-curation">
            <span class="tab-label">Kurasi</span>
            <span class="tab-subtitle">Konten</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-analytics" data-action="jump-section" data-target="#mod-analytics">
            <span class="tab-label">Analitik</span>
            <span class="tab-subtitle">Insight</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-policies" data-action="jump-section" data-target="#mod-policies">
            <span class="tab-label">Kebijakan</span>
            <span class="tab-subtitle">SOP</span>
          </a>
        </li>
        <li class="tab-list__item">
          <a class="tab-link" href="#mod-help" data-action="jump-section" data-target="#mod-help">
            <span class="tab-label">Bantuan</span>
            <span class="tab-subtitle">Support</span>
          </a>
        </li>
      </ul>
      <span class="tab-indicator" aria-hidden="true"></span>
    </div>
    <div class="tab-actions">
      <button type="button" class="btn btn-ghost" data-action="scroll-top">Kembali ke Atas</button>
    </div>
  </div>
</nav>

<section id="mod-overview" class="mod-overview glass-surface">
  <header class="section-heading">
    <div>
      <h2>Overview &amp; Alerts</h2>
      <p>Monitor kesehatan operasional, SLA, dan eskalasi lintas tim dalam satu layar.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-ghost" data-action="refresh-snapshot">Refresh</button>
      <button type="button" class="btn btn-outline">Download KPI</button>
    </div>
  </header>
  <div class="overview-grid">
    <div class="summary-pills" role="list">
      {% for summary in snapshot.report_summary %}
      <article class="summary-pill tone-{{ summary.tone }}" role="listitem">
        <span class="summary-value">{{ summary.value }}</span>
        <span class="summary-label">{{ summary.label }}</span>
      </article>
      {% endfor %}
    </div>
    <aside class="alert-stream" aria-label="Daftar alert terbaru">
      <h3>Alert &amp; Eskalasi</h3>
      <ul class="alert-list">
        {% for alert in snapshot.alerts %}
        <li class="alert-item glass-card severity-{{ alert.severity }}">
          <div class="alert-header">
            <span class="alert-severity">{{ alert.severity|title }}</span>
            <span class="alert-time">{{ alert.timestamp }}</span>
          </div>
          <h4>{{ alert.title }}</h4>
          <p>{{ alert.description }}</p>
          <div class="alert-actions">
            <button type="button" class="btn btn-ghost">Tandai selesai</button>
            <button type="button" class="btn btn-outline">Lihat detail</button>
          </div>
        </li>
        {% endfor %}
      </ul>
    </aside>
  </div>
</section>

<section id="mod-team" class="mod-team">
  <article class="glass-surface team-roster">
    <header class="section-heading">
      <div>
        <h2>Manajemen Tim &amp; Peran</h2>
        <p>Kelola moderator, kurator, dan Quality Lead dengan visibilitas penuh terhadap kapasitas.</p>
      </div>
      <div class="section-tools">
        <button type="button" class="btn gradient-button" onclick="openTeamInviteModal()">Undang Pengguna</button>
        <button type="button" class="btn btn-outline">Atur Shift</button>
      </div>
    </header>
    <div class="team-layout">
      <div class="team-table" role="table" aria-label="Daftar anggota tim">
        <div class="team-header" role="row">
          <span role="columnheader">Nama</span>
          <span role="columnheader">Peran</span>
          <span role="columnheader">Status</span>
          <span role="columnheader">Kasus Aktif</span>
          <span role="columnheader">Aktivitas Terakhir</span>
          <span role="columnheader">Shift</span>
        </div>
        {% for member in snapshot.team_members %}
        <div class="team-row" role="row">
          <span role="cell">{{ member.name }}</span>
          <span role="cell">{{ member.role }}</span>
          <span role="cell">{{ member.status }}</span>
          <span role="cell">{{ member.active_cases }}</span>
          <span role="cell">{{ member.last_active }}</span>
          <span role="cell">{{ member.shift }}</span>
        </div>
        {% endfor %}
      </div>
      <aside class="team-sidepanel">
        <section class="invite-panel">
          <h3>Undangan Pending</h3>
          <ul>
            {% for invite in snapshot.pending_invites %}
            <li>
              <p><strong>{{ invite.email }}</strong> Â· {{ invite.role }}</p>
              <p>Dikirim {{ invite.sent_at }} Â· Kedaluwarsa {{ invite.expires_at }}</p>
              <div class="panel-actions">
                <button type="button" class="btn btn-ghost" data-action="invite-resend" data-invite-email="{{ invite.email }}">Kirim ulang</button>
                <button type="button" class="btn btn-outline" data-action="invite-cancel" data-invite-email="{{ invite.email }}">Batalkan</button>
              </div>
            </li>
            {% endfor %}
          </ul>
        </section>
        <section class="audit-trail">
          <h3>Audit Trail Terbaru</h3>
          <ol>
            {% for entry in snapshot.audit_trail %}
            <li>
              <span class="audit-time">{{ entry.time }}</span>
              <div>
                <strong>{{ entry.actor }}</strong>
                <p>{{ entry.action }}</p>
              </div>
            </li>
            {% endfor %}
          </ol>
        </section>
      </aside>
    </div>
  </article>
</section>

<section id="mod-queues" class="mod-queues glass-surface">
  <header class="section-heading">
    <div>
      <h2>Moderasi Laporan</h2>
      <p>Prioritaskan laporan komunitas, transaksi, dan pelanggaran seller sesuai SLA.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-ghost" data-action="focus-mode" data-focus-target="{{ request.url.path ~ '?view=focus' }}">Mode Fokus</button>
      <button type="button" class="btn btn-outline" data-action="bulk-action" data-bulk-target=".queue-table">Bulk Action</button>
    </div>
  </header>
  <div class="queue-grid">
    <aside class="queue-sidebar">
      <h3>Status Antrian</h3>
      <ul>
        {% for item in snapshot.report_summary %}
        <li><span class="indicator tone-{{ item.tone }}"></span>{{ item.label }} Â· {{ item.value }}</li>
        {% endfor %}
      </ul>
      <div class="queue-note">
        <p>Pemetaan otomatis berdasarkan kapasitas moderator aktif. Tiket tanpa pemilik akan muncul paling atas.</p>
      </div>
    </aside>
    <div class="queue-table-wrapper">
      <table class="queue-table">
        <thead>
          <tr>
            <th scope="col">Ticket</th>
            <th scope="col">Kategori</th>
            <th scope="col">Prioritas</th>
            <th scope="col">Status</th>
            <th scope="col">SLA</th>
            <th scope="col">Penanggung Jawab</th>
            <th scope="col">Sumber</th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in snapshot.report_tickets %}
          <tr>
            <td>{{ ticket.ticket_id }}</td>
            <td>{{ ticket.category }}</td>
            <td><span class="priority-badge priority-{{ ticket.priority | lower }}">{{ ticket.priority }}</span></td>
            <td>{{ ticket.status }}</td>
            <td>{{ ticket.sla_remaining }}</td>
            <td>{{ ticket.assigned_to }}</td>
            <td>{{ ticket.source }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section id="mod-curation" class="mod-curation glass-surface">
  <header class="section-heading">
    <div>
      <h2>Kurasi Konten &amp; Brand</h2>
      <p>Checklist kualitas dan riwayat brand terkonsolidasi membantu keputusan lebih cepat.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-outline">Checklist Kurasi</button>
      <button type="button" class="btn btn-ghost">Kolaborasi</button>
    </div>
  </header>
  <div class="curation-grid">
    <aside>
      <h3>Ringkasan Pipeline</h3>
      <ul class="summary-list">
        {% for summary in snapshot.curation_summary %}
        <li class="tone-{{ summary.tone }}">
          <span class="summary-value">{{ summary.value }}</span>
          <span class="summary-label">{{ summary.label }}</span>
        </li>
        {% endfor %}
      </ul>
      <h4>Highlight Checklist</h4>
      <ul class="checklist">
        {% for item in snapshot.checklist_highlights %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
    </aside>
    <div class="curation-table-wrapper">
      <table class="curation-table">
        <thead>
          <tr>
            <th scope="col">Brand / Kampanye</th>
            <th scope="col">Tipe</th>
            <th scope="col">Pemilik</th>
            <th scope="col">Status</th>
            <th scope="col">Update Terakhir</th>
            <th scope="col">Catatan</th>
            <th scope="col">Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for submission in snapshot.curation_submissions %}
          <tr>
            <td>{{ submission.brand }}</td>
            <td>{{ submission.submission_type }}</td>
            <td>{{ submission.owner }}</td>
            <td>{{ submission.status }}</td>
            <td>{{ submission.updated }}</td>
            <td>{{ submission.notes }}</td>
            <td>
              {% if submission.status == 'Pending Review' or submission.status == 'Perlu Revisi' %}
              <div style="display: flex; gap: 0.5rem;">
                <button 
                  type="button" 
                  class="btn btn-ghost moderation-action" 
                  data-action="approve"
                  data-brand="{{ submission.brand_slug }}"
                  title="Setujui">âœ“</button>
                <button 
                  type="button" 
                  class="btn btn-ghost moderation-action" 
                  data-action="request_revision"
                  data-brand="{{ submission.brand_slug }}"
                  title="Minta Revisi">âŸ³</button>
                <button 
                  type="button" 
                  class="btn btn-ghost moderation-action" 
                  data-action="reject"
                  data-brand="{{ submission.brand_slug }}"
                  title="Tolak">âœ—</button>
              </div>
              {% elif submission.status == 'Approved' %}
              <span style="color: #4ade80;">Disetujui</span>
              {% else %}
              <span style="color: #94a3b8;">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section id="mod-analytics" class="mod-analytics glass-surface">
  <header class="section-heading">
    <div>
      <h2>Analitik &amp; Insight</h2>
      <p>Jelajahi metrik utama untuk menjaga kualitas keputusan dan efisiensi operasional.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-outline">Ekspor CSV</button>
      <button type="button" class="btn btn-ghost">Penjadwalan Laporan</button>
    </div>
  </header>
  <div class="analytics-grid">
    <div class="insight-cards">
      {% for insight in snapshot.insights %}
      <article class="insight-card glass-card tone-{{ insight.tone }}">
        <h3>{{ insight.label }}</h3>
        <p class="insight-value">{{ insight.current }}</p>
        <p>{{ insight.change }}</p>
      </article>
      {% endfor %}
    </div>
    <div class="analytics-details">
      <section>
        <h3>Heatmap Beban Kerja</h3>
        <ul class="heatmap">
          {% for slot in snapshot.heatmap %}
          <li class="heatmap-slot state-{{ slot.state }}">
            <span>{{ slot.label }}</span>
            <strong>{{ slot.load }}</strong>
          </li>
          {% endfor %}
        </ul>
      </section>
      <section>
        <h3>Top Kategori Pelanggaran</h3>
        <ol class="violation-list">
          {% for violation in snapshot.violations %}
          <li>
            <span>{{ violation.category }}</span>
            <strong>{{ violation.count }}</strong>
          </li>
          {% endfor %}
        </ol>
      </section>
      <section>
        <h3>Performa Tim</h3>
        <table class="team-performance">
          <thead>
            <tr>
              <th scope="col">Nama</th>
              <th scope="col">Kasus Selesai</th>
              <th scope="col">Akurasi Audit</th>
            </tr>
          </thead>
          <tbody>
            {% for member in snapshot.team_productivity %}
            <tr>
              <td>{{ member.name }}</td>
              <td>{{ member.resolved }}</td>
              <td>{{ member.accuracy }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </div>
  </div>
</section>

<section id="mod-policies" class="mod-policies glass-surface">
  <header class="section-heading">
    <div>
      <h2>Pengaturan Kebijakan &amp; Template</h2>
      <p>Simpan jejak perubahan kebijakan serta template komunikasi lintas peran.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-outline">Buat Kebijakan</button>
      <button type="button" class="btn btn-ghost">Atur Automasi</button>
    </div>
  </header>
  <div class="policy-grid">
    <section>
      <h3>Kebijakan Terbaru</h3>
      <ul class="policy-list">
        {% for policy in snapshot.policies %}
        <li class="glass-card">
          <div>
            <h4>{{ policy.title }}</h4>
            <p>Versi {{ policy.version }} Â· {{ policy.updated_at }} Â· Oleh {{ policy.owner }}</p>
          </div>
          <div class="policy-tags">
            {% for tag in policy.tags %}<span>{{ tag }}</span>{% endfor %}
          </div>
        </li>
        {% endfor %}
      </ul>
    </section>
    <section>
      <h3>Template Pesan</h3>
      <ul class="template-list">
        {% for template in snapshot.templates %}
        <li>
          <strong>{{ template.name }}</strong>
          <p>Untuk {{ template.usage }} Â· Update {{ template.updated_at }}</p>
        </li>
        {% endfor %}
      </ul>
      <h4>Aturan Automasi</h4>
      <ul class="automation-list">
        {% for rule in snapshot.automation_rules %}
        <li>{{ rule }}</li>
        {% endfor %}
      </ul>
    </section>
  </div>
</section>

<section id="mod-help" class="mod-help glass-surface">
  <header class="section-heading">
    <div>
      <h2>Pusat Bantuan Internal</h2>
      <p>Dukung pembelajaran berkelanjutan dan jalur eskalasi jelas untuk seluruh tim moderasi.</p>
    </div>
    <div class="section-tools">
      <button type="button" class="btn btn-outline">Kirim Feedback</button>
      <button type="button" class="btn btn-ghost">Jadwalkan Coaching</button>
    </div>
  </header>
  <div class="help-grid">
    <section>
      <h3>Materi &amp; FAQ</h3>
      <ul class="resource-list">
        {% for resource in snapshot.help_resources %}
        <li class="glass-card">
          <h4>{{ resource.title }}</h4>
          <p>{{ resource.category }} Â· {{ resource.format }} Â· Update {{ resource.updated_at }}</p>
        </li>
        {% endfor %}
      </ul>
    </section>
    <section>
      <h3>Kontak Eskalasi</h3>
      <ul class="contact-list">
        {% for contact in snapshot.contacts %}
        <li>
          <strong>{{ contact.name }}</strong>
          <p>{{ contact.role }} Â· {{ contact.channel }} Â· {{ contact.availability }}</p>
        </li>
        {% endfor %}
      </ul>
      <div class="feedback-box glass-card">
        <h4>Form Masukan Cepat</h4>
        <p>Catat kendala atau ide perbaikan. Admin akan menindaklanjuti dalam 24 jam.</p>
        <button type="button" class="btn gradient-button">Buka Form</button>
      </div>
    </section>
  </div>
</section>
{% endblock %}

<!-- Team Invitation Modal -->
<div id="team-invite-modal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="closeTeamInviteModal()"></div>
  <div class="modal-content glass-surface">
    <header class="modal-header">
      <h2>Undang Anggota Tim</h2>
      <button type="button" class="btn btn-ghost" onclick="closeTeamInviteModal()">&times;</button>
    </header>
    
    <form id="team-invite-form">
      <div class="form-group">
        <label for="invite-brand">Brand <span class="required">*</span></label>
        <input 
          type="text" 
          id="invite-brand" 
          name="brand_slug" 
          required 
          placeholder="brand-slug"
          class="form-control"
        />
        <small class="form-hint">Masukkan slug brand (e.g., studio-senja)</small>
      </div>

      <div class="form-group">
        <label for="invite-profile-id">Profile ID <span class="required">*</span></label>
        <input 
          type="text" 
          id="invite-profile-id" 
          name="profile_id" 
          required 
          placeholder="user-profile-id"
          class="form-control"
        />
        <small class="form-hint">ID profil user yang akan diundang</small>
      </div>

      <div class="form-group">
        <label for="invite-name">Nama Lengkap <span class="required">*</span></label>
        <input 
          type="text" 
          id="invite-name" 
          name="full_name" 
          required 
          minlength="3"
          maxlength="100"
          placeholder="Nama lengkap anggota"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label for="invite-username">Username <span class="required">*</span></label>
        <input 
          type="text" 
          id="invite-username" 
          name="username" 
          required 
          minlength="3"
          maxlength="50"
          placeholder="@username"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label for="invite-expertise">Keahlian (opsional)</label>
        <input 
          type="text" 
          id="invite-expertise" 
          name="expertise" 
          maxlength="200"
          placeholder="Contoh: Perfumer, Designer, Copywriter"
          class="form-control"
        />
      </div>

      <div id="team-invite-response" class="form-response"></div>

      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeTeamInviteModal()">Batal</button>
        <button type="submit" class="btn gradient-button">
          <span class="btn-text">Kirim Undangan</span>
          <span class="btn-loading" style="display: none;">Mengirim...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
}

.modal-content {
  position: relative;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 2rem;
  border-radius: 16px;
  z-index: 1001;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
}

.modal-header .btn-ghost {
  font-size: 2rem;
  line-height: 1;
  padding: 0.25rem 0.5rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-group .required {
  color: #ef4444;
}

.form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.05);
  color: inherit;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.form-control:focus {
  outline: none;
  border-color: rgba(56, 189, 248, 0.5);
  background: rgba(255, 255, 255, 0.08);
}

.form-hint {
  display: block;
  margin-top: 0.25rem;
  font-size: 0.875rem;
  opacity: 0.7;
}

.form-response {
  margin-top: 1rem;
}

.form-response.success {
  padding: 1rem;
  border-radius: 8px;
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #22c55e;
}

.form-response.error {
  padding: 1rem;
  border-radius: 8px;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.modal-footer {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}
</style>

<script>
// Team invitation modal
function openTeamInviteModal() {
  document.getElementById('team-invite-modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeTeamInviteModal() {
  document.getElementById('team-invite-modal').style.display = 'none';
  document.body.style.overflow = 'auto';
  document.getElementById('team-invite-form').reset();
  document.getElementById('team-invite-response').innerHTML = '';
}

// Team invitation form submission
document.getElementById('team-invite-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const data = {
    brand_slug: formData.get('brand_slug'),
    profile_id: formData.get('profile_id'),
    full_name: formData.get('full_name'),
    username: formData.get('username'),
    expertise: formData.get('expertise') || null
  };
  
  const responseDiv = document.getElementById('team-invite-response');
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnLoading = submitBtn.querySelector('.btn-loading');
  
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline';
  submitBtn.disabled = true;
  
  try {
    const response = await fetch('/api/team/invite', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      responseDiv.className = 'form-response success';
      responseDiv.innerHTML = 'âœ“ ' + result.message;
      
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      responseDiv.className = 'form-response error';
      responseDiv.innerHTML = 'âœ— ' + (result.detail || 'Terjadi kesalahan saat mengirim undangan');
    }
  } catch (error) {
    responseDiv.className = 'form-response error';
    responseDiv.innerHTML = 'âœ— Terjadi kesalahan koneksi. Silakan coba lagi.';
  } finally {
    btnText.style.display = 'inline';
    btnLoading.style.display = 'none';
    submitBtn.disabled = false;
  }
});

// Moderation actions
document.addEventListener('click', async function(e) {
  if (e.target.classList.contains('moderation-action')) {
    const action = e.target.dataset.action;
    const brandSlug = e.target.dataset.brand;
    
    if (!confirm(`Apakah Anda yakin ingin ${action === 'approve' ? 'menyetujui' : action === 'reject' ? 'menolak' : 'meminta revisi'} brand ini?`)) {
      return;
    }
    
    const notes = action !== 'approve' ? prompt('Catatan (opsional):') : null;
    
    try {
      const response = await fetch(`/api/moderation/brands/${brandSlug}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: action,
          notes: notes
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('âœ“ ' + result.message);
        window.location.reload();
      } else {
        alert('âœ— ' + (result.detail || 'Terjadi kesalahan'));
      }
    } catch (error) {
      alert('âœ— Terjadi kesalahan koneksi. Silakan coba lagi.');
    }
  }
});
</script>

{% block body_scripts %}
{{ super() }}
<script src="{{ url_for('static', path='js/moderation-dashboard.js') }}?{{ static_asset_query }}" defer></script>
{% endblock %}
