{% extends "base.html" %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', path='css/profile.min.css') if use_minified else url_for('static', path='css/profile.css') }}?v={{ static_asset_query }}" />
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    const updateActiveTab = (button, focusPanel = false) => {
      if (!button) {
        return;
      }
      const nav = button.closest(".profile-tabs__nav");
      const panel = document.getElementById("profile-tab-content");
      if (!nav || !panel) {
        return;
      }

      nav.querySelectorAll(".profile-tabs__button").forEach((item) => {
        const isActive = item === button;
        item.classList.toggle("profile-tabs__button--active", isActive);
        item.setAttribute("aria-selected", isActive ? "true" : "false");
        item.setAttribute("tabindex", isActive ? "0" : "-1");
        if (isActive) {
          panel.setAttribute("aria-labelledby", item.id);
        }
      });

      panel.setAttribute("role", "tabpanel");
      if (!panel.hasAttribute("tabindex")) {
        panel.setAttribute("tabindex", "0");
      }
      if (focusPanel && panel.getAttribute("tabindex") !== "-1") {
        panel.focus();
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const activeTab = document.querySelector(
        ".profile-tabs__button[aria-selected='true']"
      );
      if (activeTab) {
        updateActiveTab(activeTab);
      }
    });

    document.addEventListener("click", (event) => {
      const button = event.target.closest(".profile-tabs__button");
      if (!button) {
        return;
      }
      const shouldFocusPanel = event.detail === 0;
      updateActiveTab(button, shouldFocusPanel);
    });

    document.body.addEventListener("htmx:afterSwap", (event) => {
      if (event.target.id !== "profile-tab-content") {
        return;
      }
      const activeTab = document.querySelector(
        ".profile-tabs__button[aria-selected='true']"
      );
      if (activeTab) {
        updateActiveTab(activeTab);
      } else {
        event.target.setAttribute("role", "tabpanel");
        if (!event.target.hasAttribute("tabindex")) {
          event.target.setAttribute("tabindex", "0");
        }
      }
    });

    (function () {
      const profileModal = document.getElementById("profile-modal");
      if (!profileModal) {
        return;
      }

      const focusableSelector = [
        "a[href]",
        "button:not([disabled])",
        "textarea:not([disabled])",
        "input:not([disabled])",
        "select:not([disabled])",
        "[tabindex]:not([tabindex='-1'])",
      ].join(", ");

      const state = {
        dialog: null,
        keydownHandler: null,
        previouslyFocusedElement: null,
        observer: null,
      };

      const restoreFocus = () => {
        if (
          state.previouslyFocusedElement &&
          typeof state.previouslyFocusedElement.focus === "function"
        ) {
          state.previouslyFocusedElement.focus();
        }
        state.previouslyFocusedElement = null;
      };

      const getFocusableElements = () => {
        if (!state.dialog) {
          return [];
        }
        return Array.from(state.dialog.querySelectorAll(focusableSelector)).filter(
          (element) => {
            if (element.hasAttribute("disabled")) {
              return false;
            }
            if (element.getAttribute("aria-hidden") === "true") {
              return false;
            }
            const style = window.getComputedStyle(element);
            if (style.display === "none" || style.visibility === "hidden") {
              return false;
            }
            return element.offsetParent !== null || style.position === "fixed";
          }
        );
      };

      const cleanup = () => {
        if (state.dialog && state.keydownHandler) {
          state.dialog.removeEventListener("keydown", state.keydownHandler);
        }
        if (state.observer) {
          state.observer.disconnect();
          state.observer = null;
        }
        state.dialog = null;
        state.keydownHandler = null;
      };

      const handleKeyDown = (event) => {
        if (!state.dialog) {
          return;
        }
        if (event.key === "Escape") {
          event.preventDefault();
          closeProfileModal();
          return;
        }
        if (event.key !== "Tab") {
          return;
        }

        const focusableElements = getFocusableElements();
        if (focusableElements.length === 0) {
          event.preventDefault();
          state.dialog.focus();
          return;
        }

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        const activeElement = document.activeElement;

        if (event.shiftKey) {
          if (activeElement === firstElement || activeElement === state.dialog) {
            event.preventDefault();
            lastElement.focus();
          }
          return;
        }

        if (activeElement === lastElement) {
          event.preventDefault();
          firstElement.focus();
        }
      };

      function closeProfileModal() {
        cleanup();
        profileModal.innerHTML = "";
        restoreFocus();
      }

      window.closeProfileModal = closeProfileModal;

      const setupDialog = (dialog) => {
        if (
          !state.previouslyFocusedElement ||
          !document.body.contains(state.previouslyFocusedElement)
        ) {
          state.previouslyFocusedElement =
            document.activeElement instanceof HTMLElement
              ? document.activeElement
              : null;
        }

        cleanup();

        state.dialog = dialog;
        state.keydownHandler = handleKeyDown;
        dialog.addEventListener("keydown", handleKeyDown);

        const focusableElements = getFocusableElements();
        if (focusableElements.length > 0) {
          focusableElements[0].focus();
        } else {
          dialog.focus();
        }

        if (state.observer) {
          state.observer.disconnect();
        }

        state.observer = new MutationObserver(() => {
          if (!profileModal.firstElementChild) {
            cleanup();
            restoreFocus();
          }
        });

        state.observer.observe(profileModal, { childList: true });
      };

      document.body.addEventListener("htmx:afterSwap", (event) => {
        if (event.target !== profileModal) {
          return;
        }

        const dialog = profileModal.querySelector("[role='dialog']");
        if (dialog) {
          setupDialog(dialog);
        } else {
          cleanup();
        }
      });
    })();
  </script>
{% endblock %}

{% block content %}
  <section class="profile-page">
    <header class="profile-hero glass-panel">
      <div class="profile-hero__avatar">
        <img src="{{ profile.avatar_url }}" alt="{{ profile.full_name }}" />
      </div>
      <div class="profile-hero__content">
        <div class="profile-hero__headline">
          <div>
            <h1>{{ profile.full_name }}</h1>
            <p class="profile-hero__username">@{{ profile.username }}</p>
          </div>
          {% include 'components/profile/follow_button.html' %}
        </div>
        <p class="profile-hero__bio">{{ profile.bio }}</p>
        <ul class="profile-hero__meta">
          {% if profile.tagline %}
            <li>{{ profile.tagline }}</li>
          {% endif %}
          {% if profile.preferred_aroma %}
            <li>Preferensi aroma: <strong>{{ profile.preferred_aroma }}</strong></li>
          {% endif %}
          {% if profile.location %}
            <li>Domisili: {{ profile.location }}</li>
          {% endif %}
        </ul>
        {% if profile_view.badges %}
          <ul class="profile-badges">
            {% for badge in profile_view.badges %}
              {% include 'components/profile/badge.html' with context %}
            {% endfor %}
          </ul>
        {% else %}
          <div class="profile-empty profile-empty--subtle">
            <p>Belum ada badge aktif. Kolaborasi dengan brand untuk menampilkan pencapaianmu.</p>
          </div>
        {% endif %}
      </div>
    </header>

    {% include 'components/profile/stats.html' %}

    <section class="profile-tabs glass-panel" aria-label="Konten profil">
      <div class="profile-tabs__nav" role="tablist">
        <button
          class="profile-tabs__button profile-tabs__button--active"
          id="profile-tab-aktivitas"
          role="tab"
          type="button"
          aria-selected="true"
          aria-controls="profile-tab-content"
          tabindex="0"
          data-tab="aktivitas"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='aktivitas') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Aktivitas</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-favorit"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="favorit"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='favorit') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Favorit</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-sambatan"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="sambatan"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='sambatan') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Sambatan</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-karya"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="karya"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='karya') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Karya Perfumer</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-brand"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="brand"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='brand') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Brand Dimiliki</button>
      </div>
      <div
        id="profile-tab-content"
        class="profile-tabs__content"
        role="tabpanel"
        aria-labelledby="profile-tab-aktivitas"
        tabindex="0"
      >
        {% include 'components/profile/tab_activity.html' %}
      </div>
    </section>
  </section>
  <div id="profile-modal" class="profile-modal" aria-live="polite"></div>
{% endblock %}
