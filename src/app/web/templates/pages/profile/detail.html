{% extends "base.html" %}

{% block head_extra %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', path='css/profile.css') }}?{{ static_asset_query }}" />
{% endblock %}

{% block body_scripts %}
  {{ super() }}
  <script>
    const updateActiveTab = (button, focusPanel = false) => {
      if (!button) {
        return;
      }
      const nav = button.closest(".profile-tabs__nav");
      const panel = document.getElementById("profile-tab-content");
      if (!nav || !panel) {
        return;
      }

      nav.querySelectorAll(".profile-tabs__button").forEach((item) => {
        const isActive = item === button;
        item.classList.toggle("profile-tabs__button--active", isActive);
        item.setAttribute("aria-selected", isActive ? "true" : "false");
        item.setAttribute("tabindex", isActive ? "0" : "-1");
        if (isActive) {
          panel.setAttribute("aria-labelledby", item.id);
        }
      });

      panel.setAttribute("role", "tabpanel");
      if (!panel.hasAttribute("tabindex")) {
        panel.setAttribute("tabindex", "0");
      }
      if (focusPanel && panel.getAttribute("tabindex") !== "-1") {
        panel.focus();
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const activeTab = document.querySelector(
        ".profile-tabs__button[aria-selected='true']"
      );
      if (activeTab) {
        updateActiveTab(activeTab);
      }
    });

    document.addEventListener("click", (event) => {
      const button = event.target.closest(".profile-tabs__button");
      if (!button) {
        return;
      }
      const shouldFocusPanel = event.detail === 0;
      updateActiveTab(button, shouldFocusPanel);
    });

    document.body.addEventListener("htmx:afterSwap", (event) => {
      if (event.target.id !== "profile-tab-content") {
        return;
      }
      const activeTab = document.querySelector(
        ".profile-tabs__button[aria-selected='true']"
      );
      if (activeTab) {
        updateActiveTab(activeTab);
      } else {
        event.target.setAttribute("role", "tabpanel");
        if (!event.target.hasAttribute("tabindex")) {
          event.target.setAttribute("tabindex", "0");
        }
      }
    });
  </script>
{% endblock %}

{% block content %}
  <section class="profile-page">
    <header class="profile-hero glass-panel">
      <div class="profile-hero__avatar">
        <img src="{{ profile.avatar_url }}" alt="{{ profile.full_name }}" />
      </div>
      <div class="profile-hero__content">
        <div class="profile-hero__headline">
          <div>
            <h1>{{ profile.full_name }}</h1>
            <p class="profile-hero__username">@{{ profile.username }}</p>
          </div>
          {% include 'components/profile/follow_button.html' %}
        </div>
        <p class="profile-hero__bio">{{ profile.bio }}</p>
        <ul class="profile-hero__meta">
          {% if profile.tagline %}
            <li>{{ profile.tagline }}</li>
          {% endif %}
          {% if profile.preferred_aroma %}
            <li>Preferensi aroma: <strong>{{ profile.preferred_aroma }}</strong></li>
          {% endif %}
          {% if profile.location %}
            <li>Domisili: {{ profile.location }}</li>
          {% endif %}
        </ul>
        {% if profile_view.badges %}
          <div class="profile-badges" role="list">
            {% for badge in profile_view.badges %}
              {% include 'components/profile/badge.html' with context %}
            {% endfor %}
          </div>
        {% else %}
          <div class="profile-empty profile-empty--subtle">
            <p>Belum ada badge aktif. Kolaborasi dengan brand untuk menampilkan pencapaianmu.</p>
          </div>
        {% endif %}
      </div>
    </header>

    {% include 'components/profile/stats.html' %}

    <section class="profile-tabs glass-panel" aria-label="Konten profil">
      <div class="profile-tabs__nav" role="tablist">
        <button
          class="profile-tabs__button profile-tabs__button--active"
          id="profile-tab-aktivitas"
          role="tab"
          type="button"
          aria-selected="true"
          aria-controls="profile-tab-content"
          tabindex="0"
          data-tab="aktivitas"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='aktivitas') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Aktivitas</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-favorit"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="favorit"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='favorit') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Favorit</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-sambatan"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="sambatan"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='sambatan') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Sambatan</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-karya"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="karya"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='karya') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Karya Perfumer</button>
        <button
          class="profile-tabs__button"
          id="profile-tab-brand"
          role="tab"
          type="button"
          aria-selected="false"
          aria-controls="profile-tab-content"
          tabindex="-1"
          data-tab="brand"
          hx-get="{{ request.url_for('profile_tab', username=profile.username, tab='brand') }}"
          hx-target="#profile-tab-content"
          hx-swap="innerHTML"
        >Brand Dimiliki</button>
      </div>
      <div
        id="profile-tab-content"
        class="profile-tabs__content"
        role="tabpanel"
        aria-labelledby="profile-tab-aktivitas"
        tabindex="0"
      >
        {% include 'components/profile/tab_activity.html' %}
      </div>
    </section>
  </section>
  <div id="profile-modal" class="profile-modal" aria-live="polite"></div>
{% endblock %}
